CREATE OR REPLACE PROCEDURE UPDATE_TAX_COMPLEX(TAX_RATE IN NUMBER)
AS
 L_ELIGIBLE BOOLEAN;
 TYPE ORDERID_TYPE IS TABLE OF SALES.ORDER_ID%TYPE INDEX BY PLS_INTEGER; --Associative Array
 
 L_ORDER_IDS ORDERID_TYPE; --Initialize
 L_ELIGIBLE_ORDERS ORDERID_TYPE; --Initialize
 
BEGIN

 SELECT DISTINCT order_id BULK COLLECT INTO L_ORDER_IDS FROM SALES;

  FOR indx IN 1..L_ORDER_IDS.COUNT
   LOOP
   
    CHECK_ELIGIBLE(L_ORDER_IDS(indx),L_ELIGIBLE);
    
    IF L_ELIGIBLE THEN
     L_ELIGIBLE_ORDERS(L_ELIGIBLE_ORDERS.COUNT + 1) := L_ORDER_IDS(indx); 
    END IF;  
   END LOOP;
  
  FORALL idx IN 1..L_ELIGIBLE_ORDERS.COUNT
     UPDATE SALES S
     SET 
        S.TAX_AMOUNT = S.TOTAL_AMOUNT * TAX_RATE
     WHERE 
        S.ORDER_ID = L_ELIGIBLE_ORDERS(idx);
     
     COMMIT;
END UPDATE_TAX_COMPLEX;

====================================================================================================

--SELECT * FROM SALES;
15-SEP-23	1269	101	13	1000	10	50	500	12.5	625
01-JAN-15	1267	100	10	1000	2	20	40	0.88	44
01-JAN-15	1267	101	10	1000	2	30	60	1.32	66
09-FEB-15	1270	105	10	3000	20	70	1400	30.8	1540
09-FEB-15	1270	106	10	3000	10	50	500	11	550
09-FEB-15	1270	101	10	3000	10	30	300	6.6	330

EXECUTE UPDATE_TAX_COMPLEX(0.5);

--SELECT * FROM SALES;
15-SEP-23	1269	101	13	1000	10	50	500	12.5	625
01-JAN-15	1267	100	10	1000	2	20	40	0.88	44
01-JAN-15	1267	101	10	1000	2	30	60	1.32	66
09-FEB-15	1270	105	10	3000	20	70	1400	770	1540
09-FEB-15	1270	106	10	3000	10	50	500	275	550
09-FEB-15	1270	101	10	3000	10	30	300	165	330


